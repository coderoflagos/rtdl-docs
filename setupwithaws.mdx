# rtdl Setup with AWS ü§∑üèΩ‚Äç‚ôÇÔ∏è

The AWS S3 destination puts the raw logs of the data Segment receives into your S3 bucket, encrypted, no matter what region the bucket is in.

The Segment Tracking API processes data from your sources, and collects the Events in batches. When these batches reach a 100 MB, or once per hour, a Segment initiates a process which uploads them to a secure Segment S3 bucket, from which they are securely copied to your own S3 bucket.

## Create a new destination üëÄ

Complete either Create an IAM role in the AWS console or Create an IAM role using the AWS CLI to configure the AWS S3 Destination with IAM Role Support.

## Create an IAM role in the AWS console üòé
To complete this section, you need access to your AWS dashboard.

- Create a new S3 bucket in your preferred region. For more information, see Amazon‚Äôs documentation, Create your first S3 bucket.
- Create a new IAM role for Segment to assume. For more information, see Amazon‚Äôs documentation, Creating a role to delegate permissions to an IAM user.
- When prompted to enter an Account ID, enter 595280932656. (You cannot enter an ARN in this step. In step 4, you can update the Principal to a specific role after you create an IAM role.)
- Click the Require External ID checkbox.
- Enter your Segment Workspace ID in the External ID field.
- Attach the following policy to the IAM role created in step 2. Replace <YOUR_BUCKET_NAME> with the name of the S3 bucket you created in step 1.

### Create an IAM role using the AWS CLI üéØ
To create an IAM role with external ID and with S3 permissions using the AWS CLI, follow the steps below.

Prerequisites
To create an S3 IAM role, you must first install and configure the AWS CLI on your local machine and create an S3 bucket. Refer to Amazon‚Äôs documentation, Getting started with the AWS CLI for more information.

Procedure
Copy the following code snippet and save it as a file on your local machine titled trust-relationship-policy.json. Replace `<YOUR_WORKSPACE_ID>` with your Segment workspace ID.

```
 {
   "Version": "2012-10-17",
   "Statement": [
     {
       "Sid": "",
       "Effect": "Allow",
       "Principal": {
         "AWS": "arn:aws:iam::595280932656:role/segment-s3-integration-production-access"
       },
       "Action": "sts:AssumeRole",
       "Condition": {
         "StringEquals": {
           "sts:ExternalId": "<YOUR_WORKSPACE_ID>"
         }
       }
     }
   ]
 }
```
Navigate to the folder containing trust-relationship-policy.json and run the following command to create your IAM role and attach the trust relationship document, replacing <YOUR_ROLE_NAME> with the name you want to give the IAM role:

 aws iam create-role --role-name <YOUR_ROLE_NAME> --assume-role-policy-document file://trust-relationship-policy.json --description "IAM role for Segment to assume (AWS S3 destination)"
To verify that the IAM role is created, log into the AWS console and open the IAM Management Console. Under the Trust Relationship tab, there should be a key-value pair: a sts:ExternalID key with a value of your Segment workspace ID.

Copy the following IAM policy, replacing `<YOUR_BUCKET_NAME>` with the name of your S3 bucket, and save it as a file on your local machine titled iam-policy.json.
```bash
 {
   "Version": "2012-10-17",
   "Statement": [
     {
       "Sid": "PutObjectsInBucket",
       "Effect": "Allow",
       "Action": [
         "s3:PutObject",
         "s3:PutObjectAcl"
       ],
       "Resource": "arn:aws:s3:::<YOUR_BUCKET_NAME>/segment-logs/*"
     }
   ]
 }
 ```
Navigate to the folder containing iam-policy.json, and run the following command to create the IAM policy:

 aws iam create-policy `--policy-name segment-s3-putobject --policy-document file://iam-policy.json --description` "Allow Segment to PutObject into S3 destination bucket".
A successful output has the following format. Take note of the Arn, as you‚Äôll need it in the next step.
 
```bash
 {
     "Policy": {
         "PolicyName": "segment-s3-putobject",
         "PolicyId": "AABC1DE2F34GG567H",
         "Arn": "arn:aws:iam::012345678912:policy/segment-s3-putobject",
         "Path": "/",
         "DefaultVersionId": "v1",
         "AttachmentCount": 0,
         "PermissionsBoundaryUsageCount": 0,
         "IsAttachable": true,
         "CreateDate": "2021-11-11T01:21:00+00:00",
         "UpdateDate": "2021-11-11T01:21:00+00:00"
     }
 }
```

Run the following command to attach the IAM policy to the IAM role, replacing `<YOUR_ROLE_NAME>` with the name of your role and `<ARN_FROM_STEP_6_OUTPUT>` with the Arn output from the last step:

 aws iam `attach-role-policy --role-name <YOUR_ROLE_NAME> --policy-arn <ARN_FROM_STEP_6_OUTPUT>`


## Add the AWS S3 with IAM Role Support Destination üåà
To finish configuration, enable the AWS S3 Destination with IAM Role Support destination in your workspace.

- Add the AWS S3 destination from the Storage Destinations tab of the catalog. This document is about the AWS S3 destination. For information about the Amazon S3 destination, which does not include IAM Role support, see the documentation [here](https://segment.com/docs/connections/storage/catalog/amazon-s3/).

- Select the data source you‚Äôll connect to the destination.

- Provide a unique name for the destination.

- Complete the destination settings:
 - Enter the name of the region in which the bucket you created above resides.
 
 - Enter the name of the bucket you created above. Be sure to enter the bucket‚Äôs name and not URI.
 
 - Enter the ARN of the IAM role you created above. The ARN should follow the format `arn:aws:iam::ACCOUNT_ID:role/ROLE_NAME.`
 
- Enable the destination.

- Verify Segment data is stored in the S3 bucket by navigating to the `<your_S3_bucket>/segment-logs` in the AWS console. The bucket will take roughly 1 hour to begin receiving data.
